<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Watch Movement Simulator / 3D時計ムーブメントシミュレーター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono&family=Noto+Sans+JP:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            margin: 0;
            overflow: hidden;
            touch-action: none;
        }

        .canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .pointer-events-auto {
            pointer-events: auto;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        input[type="range"] {
            accent-color: #3b82f6;
        }

        .active-btn {
            background-color: #3b82f6 !important;
            color: white !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .lang-active {
            color: #3b82f6;
            font-weight: 700;
            border-bottom: 2px solid #3b82f6;
        }

        /* Bubble Style Panel */
        .glass-panel {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }

        .bubble-collapsed {
            width: 64px;
            height: 64px;
            border-radius: 32px;
            padding: 0;
        }

        .bubble-expanded {
            width: 320px;
            height: auto;
            border-radius: 24px;
            padding: 1.5rem;
        }

        .content-fade {
            transition: opacity 0.3s ease;
        }

        .hidden-content {
            opacity: 0;
            pointer-events: none;
            display: none;
        }

        /* Indicator Rotation */
        .toggle-icon {
            transition: transform 0.5s ease;
        }
        .rotated {
            transform: rotate(135deg);
        }

        #wave-monitor {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        @media (max-width: 640px) {
            .bubble-expanded {
                width: calc(100vw - 2rem);
            }
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="three-container" class="canvas-container"></div>

    <!-- UI Overlay -->
    <div class="ui-overlay p-4 md:p-8">
        
        <!-- Top Nav (Logo/Lang) -->
        <div class="flex justify-between items-start pointer-events-none">
            <div class="pointer-events-auto">
                <h1 id="main-title" class="text-xl md:text-2xl font-bold tracking-tight">3D Movement Simulator</h1>
                <p id="main-subtitle" class="text-slate-400 text-xs md:text-sm">Explore horological physics in 3D Space.</p>
            </div>
            
            <div class="pointer-events-auto flex gap-4 bg-slate-800/80 backdrop-blur px-4 py-2 rounded-full border border-slate-700 text-[10px] font-semibold uppercase tracking-wider">
                <button id="lang-en" onclick="setLang('en')" class="lang-active transition-colors hover:text-blue-400">English</button>
                <span class="text-slate-600">|</span>
                <button id="lang-jp" onclick="setLang('jp')" class="transition-colors hover:text-blue-400">日本語</button>
            </div>
        </div>

        <!-- Floating Left Bubble Panel -->
        <div class="absolute bottom-8 left-4 md:left-8 pointer-events-auto">
            <div id="settings-bubble" class="glass-panel bubble-expanded flex flex-col relative">
                
                <!-- Bubble Toggle Trigger -->
                <button onclick="toggleSelection()" class="flex items-center justify-between w-full group">
                    <div id="collapsed-hint" class="hidden-content flex items-center justify-center w-full h-16">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <div id="expanded-header" class="flex items-center justify-between w-full mb-4">
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-4 bg-blue-500 rounded-full"></span>
                            <h2 id="select-title" class="text-xs font-semibold uppercase tracking-widest text-slate-400">Settings</h2>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="bps-display" class="text-blue-400 mono font-bold text-sm">16 BPS</span>
                            <div class="toggle-icon bg-slate-700/50 p-1.5 rounded-full group-hover:bg-blue-500/20">
                                <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </div>
                        </div>
                    </div>
                </button>

                <!-- Expanded Content -->
                <div id="bubble-content" class="space-y-4">
                    <!-- Sine Wave Visualizer -->
                    <div class="relative w-full h-16 mb-2">
                        <canvas id="wave-monitor" width="280" height="64" class="w-full h-full"></canvas>
                        <div id="wave-label" class="absolute top-1 left-2 text-[8px] font-bold text-blue-500/50 uppercase tracking-widest">Escapement Waveform</div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setBPS(1)" class="bps-btn p-2 rounded-lg bg-slate-700/40 hover:bg-slate-600 transition-all text-[10px] mono">1 BPS</button>
                        <button onclick="setBPS(4)" class="bps-btn p-2 rounded-lg bg-slate-700/40 hover:bg-slate-600 transition-all text-[10px] mono">4 BPS</button>
                        <button onclick="setBPS(6)" class="bps-btn p-2 rounded-lg bg-slate-700/40 hover:bg-slate-600 transition-all text-[10px] mono">6 BPS</button>
                        <button onclick="setBPS(8)" class="bps-btn p-2 rounded-lg bg-slate-700/40 hover:bg-slate-600 transition-all text-[10px] mono">8 BPS</button>
                        <button onclick="setBPS(10)" class="bps-btn p-2 rounded-lg bg-slate-700/40 hover:bg-slate-600 transition-all text-[10px] mono">10 BPS</button>
                        <button onclick="setBPS(16)" class="bps-btn p-2 rounded-lg bg-slate-700/40 hover:bg-slate-600 transition-all text-[10px] mono active-btn">16 BPS</button>
                        <button onclick="setBPS(0)" class="bps-btn col-span-2 p-2 rounded-lg bg-slate-700/40 hover:bg-slate-600 transition-all text-[10px] mono border border-blue-500/30" data-key="label-0">SWEEP</button>
                    </div>

                    <div class="space-y-4 border-t border-slate-700/50 pt-4">
                        <div class="flex items-center justify-between mb-2">
                            <label id="sound-label" class="text-[10px] font-bold uppercase text-slate-500">Audio Feedback</label>
                            <button onclick="toggleAudio()" id="audio-toggle" class="bg-slate-700/60 p-1.5 rounded-lg hover:bg-blue-500/20 transition-colors pointer-events-auto">
                                <svg id="audio-icon" class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                                    <path id="audio-wave" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H13"></path>
                                    <path id="audio-muted" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 8l-6 6m0-6l6 6"></path>
                                </svg>
                            </button>
                        </div>

                        <div>
                            <div class="flex justify-between mb-1">
                                <label id="custom-label" class="text-[10px] font-bold uppercase text-slate-500">Fine Tune</label>
                                <span id="custom-val" class="text-blue-400 text-xs mono">16</span>
                            </div>
                            <input id="bps-slider" type="range" min="1" max="60" value="16" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <p id="info-text" class="text-[10px] text-slate-400 leading-relaxed italic h-12 overflow-y-auto">
                            The Bulova Precisionist movement pulses 16 times per second.
                        </p>
                    </div>
                </div>
            </div>
            
            <div id="drag-hint-container" class="mt-4 opacity-50">
                <p class="text-[9px] text-slate-500 uppercase tracking-widest text-center" id="drag-hint">Click & Drag to Rotate</p>
            </div>
        </div>
    </div>

    <script>
        // --- I18N DATA ---
        const i18n = {
            en: {
                title: "3D Movement Simulator",
                subtitle: "Interactive visualization of horological physics.",
                select: "Settings",
                custom: "Fine Tune",
                audio: "Audio Feedback",
                hint: "Click & Drag to Rotate",
                bps_text: "BPS",
                cont_text: "CONTINUOUS",
                wave: "Escapement Waveform",
                labels: { 0: "Sweep", 1: "Quartz", 4: "VH31", 6: "Mech", 8: "High-Beat", 10: "Luxury", 16: "Bulova" },
                infoMap: {
                    1: "1 BPS: Standard Quartz. Ticks once per second.",
                    4: "4 BPS: Seiko VH31 'Quartz Sweep'. Smoother than standard.",
                    6: "6 BPS: Entry mechanical standard (21,600 VPH).",
                    8: "8 BPS: High-Beat standard (28,800 VPH). Luxury Swiss standard.",
                    10: "10 BPS: High-precision mechanical (36,000 VPH). Very fluid.",
                    16: "16 BPS: Bulova Ultra-High Frequency. Visually fluid.",
                    0: "Continuous: The Spring Drive motion. Perfect circularity. Silent.",
                    custom: "Custom: {x} Hz frequency simulation."
                }
            },
            jp: {
                title: "3D秒針シミュレーター",
                subtitle: "時計ムーブメントの物理的挙動を探求します。",
                select: "設定",
                custom: "微調整",
                audio: "オーディオ設定",
                hint: "ドラッグして回転",
                bps_text: "BPS",
                cont_text: "スイープ運針",
                wave: "脱進機波形",
                labels: { 0: "スイープ", 1: "クォーツ", 4: "VH31", 6: "標準メカ", 8: "ハイビート", 10: "高級", 16: "高精度" },
                infoMap: {
                    1: "1 BPS: 標準クォーツ。電池寿命優先の1秒刻みです。",
                    4: "4 BPS: セイコー VH31。手頃なスイープ運針です。",
                    6: "6 BPS: 標準的な機械式。21,600振動の伝統的な動き。",
                    8: "8 BPS: ハイビート。高級機に多い28,800振動の滑らかさ。",
                    10: "10 BPS: 高級ハイビート。36,000振動の極上の運針。",
                    16: "16 BPS: ブローバ高精度。クォーツながら16ステップの流麗さ。",
                    0: "スイープ: スプリングドライブ。無音の連続運針。",
                    custom: "カスタム設定: 毎秒{x}ステップのシミュレーション。"
                }
            }
        };

        // --- STATE ---
        let currentLang = 'en';
        let currentBPS = 16;
        let isContinuous = false;
        let selectionCollapsed = false;
        let lastTickId = -1;
        let isMuted = true;
        let audioCtx = null;
        let noiseBuffer = null;

        // Waveform Visualizer Logic
        const waveCanvas = document.getElementById('wave-monitor');
        const waveCtx = waveCanvas.getContext('2d');
        let waveHistory = new Array(280).fill(32); // Buffer for scroll
        let lastTickVisualStrength = 0;

        // --- AUDIO LOGIC ---
        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const bufferSize = audioCtx.sampleRate * 0.05;
            noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
        }

        function toggleAudio() {
            initAudio();
            isMuted = !isMuted;
            const wave = document.getElementById('audio-wave');
            const muted = document.getElementById('audio-muted');
            const icon = document.getElementById('audio-icon');

            if (isMuted) {
                wave.classList.add('hidden');
                muted.classList.remove('hidden');
                icon.classList.remove('text-blue-400');
                icon.classList.add('text-slate-400');
            } else {
                wave.classList.remove('hidden');
                muted.classList.add('hidden');
                icon.classList.add('text-blue-400');
                icon.classList.remove('text-slate-400');
                if (audioCtx.state === 'suspended') audioCtx.resume();
            }
        }

        function playTick(isToc) {
            lastTickVisualStrength = 1.0; // Trigger visual peak
            if (!audioCtx || isMuted || isContinuous || !noiseBuffer) return;

            const now = audioCtx.currentTime;
            const noiseSource = audioCtx.createBufferSource();
            noiseSource.buffer = noiseBuffer;
            const noiseGain = audioCtx.createGain();
            const noiseFilter = audioCtx.createBiquadFilter();

            noiseFilter.type = 'highpass';
            noiseFilter.frequency.setValueAtTime(2000, now);
            noiseGain.gain.setValueAtTime(0.04, now);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, now + (isToc ? 0.015 : 0.012));

            noiseSource.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(audioCtx.destination);

            const osc = audioCtx.createOscillator();
            const oscGain = audioCtx.createGain();
            const oscFilter = audioCtx.createBiquadFilter();
            osc.type = 'sine';
            const baseFreq = isToc ? 4500 : 5200;
            osc.frequency.setValueAtTime(baseFreq, now);
            oscFilter.type = 'bandpass';
            oscFilter.frequency.setValueAtTime(baseFreq, now);
            oscFilter.Q.setValueAtTime(10, now);
            oscGain.gain.setValueAtTime(0.02, now);
            oscGain.gain.exponentialRampToValueAtTime(0.001, now + (isToc ? 0.04 : 0.035));

            osc.connect(oscFilter);
            oscFilter.connect(oscGain);
            oscGain.connect(audioCtx.destination);

            noiseSource.start(now);
            osc.start(now);
            osc.stop(now + 0.05);
        }

        function updateWaveform() {
            const time = Date.now() / 1000;
            let val;
            
            if (isContinuous) {
                // High frequency smooth sine for Spring Drive
                val = 32 + Math.sin(time * 60) * 15;
            } else {
                // Beats per second sine wave that pulses on ticks
                const freq = currentBPS * Math.PI * 2;
                // Base sine wave representing the rhythm
                const baseSine = Math.sin(time * freq);
                // Pulse from the tick trigger
                val = 32 + (baseSine * 10) + (lastTickVisualStrength * Math.sin(time * 100) * 20);
                lastTickVisualStrength *= 0.9; // Decay peak
            }

            waveHistory.push(val);
            if (waveHistory.length > waveCanvas.width) waveHistory.shift();

            // Render
            waveCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
            
            // Grid lines
            waveCtx.strokeStyle = 'rgba(59, 130, 246, 0.1)';
            waveCtx.lineWidth = 1;
            waveCtx.beginPath();
            waveCtx.moveTo(0, 32); waveCtx.lineTo(280, 32);
            waveCtx.stroke();

            // Wave path
            waveCtx.strokeStyle = isContinuous ? '#60a5fa' : '#3b82f6';
            waveCtx.lineWidth = 2;
            waveCtx.beginPath();
            for(let i = 0; i < waveHistory.length; i++) {
                waveCtx.lineTo(i, waveHistory[i]);
            }
            waveCtx.stroke();

            // Glow effect
            waveCtx.strokeStyle = isContinuous ? 'rgba(96, 165, 250, 0.3)' : 'rgba(59, 130, 246, 0.3)';
            waveCtx.lineWidth = 4;
            waveCtx.stroke();
        }

        // --- THREE.JS SETUP ---
        let scene, camera, renderer, watchGroup;
        let hourHand, minuteHand, secondHand;
        let mouseX = 0, mouseY = 0, targetRotationX = 0, targetRotationY = 0;
        let windowHalfX = window.innerWidth / 2;
        let windowHalfY = window.innerHeight / 2;
        let isMouseDown = false;

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('three-container').appendChild(renderer.domElement);

            watchGroup = new THREE.Group();
            scene.add(watchGroup);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 1);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);
            const rimLight = new THREE.PointLight(0x3b82f6, 0.4);
            rimLight.position.set(-5, -2, 2);
            scene.add(rimLight);

            createWatch();
            
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('mousedown', () => isMouseDown = true);
            document.addEventListener('mouseup', () => isMouseDown = false);
            document.addEventListener('mousemove', onDocumentMouseMove);
            document.addEventListener('touchstart', (e) => isMouseDown = true);
            document.addEventListener('touchend', (e) => isMouseDown = false);
            document.addEventListener('touchmove', onTouchMove);
        }

        function createWatch() {
            const caseGeom = new THREE.CylinderGeometry(3.2, 3.2, 0.6, 64);
            const caseMat = new THREE.MeshPhongMaterial({ color: 0x334155, shininess: 100 });
            const watchCase = new THREE.Mesh(caseGeom, caseMat);
            watchCase.rotation.x = Math.PI / 2;
            watchGroup.add(watchCase);

            const dialGeom = new THREE.CircleGeometry(3, 64);
            const dialMat = new THREE.MeshPhongMaterial({ color: 0x1e293b });
            const dial = new THREE.Mesh(dialGeom, dialMat);
            dial.position.z = 0.31;
            watchGroup.add(dial);

            for (let i = 0; i < 60; i++) {
                const isMajor = i % 5 === 0;
                const markerGeom = new THREE.BoxGeometry(isMajor ? 0.1 : 0.03, isMajor ? 0.4 : 0.15, 0.05);
                const markerMat = new THREE.MeshPhongMaterial({ color: isMajor ? 0xffffff : 0x64748b });
                const marker = new THREE.Mesh(markerGeom, markerMat);
                const angle = (i / 60) * Math.PI * 2;
                marker.position.x = Math.sin(angle) * 2.7;
                marker.position.y = Math.cos(angle) * 2.7;
                marker.position.z = 0.35;
                marker.rotation.z = -angle;
                watchGroup.add(marker);
            }

            const hHandGeom = new THREE.BoxGeometry(0.18, 1.8, 0.04);
            hourHand = new THREE.Mesh(hHandGeom, new THREE.MeshPhongMaterial({ color: 0xf8fafc }));
            hourHand.geometry.translate(0, 0.9, 0);
            hourHand.position.z = 0.36;
            watchGroup.add(hourHand);

            const mHandGeom = new THREE.BoxGeometry(0.12, 2.6, 0.04);
            minuteHand = new THREE.Mesh(mHandGeom, new THREE.MeshPhongMaterial({ color: 0x94a3b8 }));
            minuteHand.geometry.translate(0, 1.3, 0);
            minuteHand.position.z = 0.38;
            watchGroup.add(minuteHand);

            const sHandGeom = new THREE.BoxGeometry(0.04, 2.8, 0.02);
            secondHand = new THREE.Mesh(sHandGeom, new THREE.MeshPhongMaterial({ color: 0xef4444 }));
            secondHand.geometry.translate(0, 1.1, 0);
            secondHand.position.z = 0.40;
            watchGroup.add(secondHand);

            const cap = new THREE.Mesh(new THREE.SphereGeometry(0.1, 16, 16), new THREE.MeshPhongMaterial({ color: 0xef4444 }));
            cap.position.z = 0.42;
            watchGroup.add(cap);
        }

        function onWindowResize() {
            windowHalfX = window.innerWidth / 2;
            windowHalfY = window.innerHeight / 2;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onDocumentMouseMove(event) {
            if (!isMouseDown) return;
            mouseX = (event.clientX - windowHalfX);
            mouseY = (event.clientY - windowHalfY);
        }

        function onTouchMove(event) {
            if (!isMouseDown) return;
            mouseX = (event.touches[0].clientX - windowHalfX);
            mouseY = (event.touches[0].clientY - windowHalfY);
        }

        function updateClock() {
            const now = new Date();
            const ms = now.getMilliseconds();
            const sec = now.getSeconds();
            const min = now.getMinutes();
            const hour = now.getHours();

            let sAngle;
            let currentStep = 0;

            if (isContinuous) {
                sAngle = -((sec * 6) + (ms * 0.006)) * (Math.PI / 180);
            } else {
                currentStep = Math.floor((ms / 1000) * currentBPS);
                sAngle = -((sec * 6) + (currentStep * (6 / currentBPS))) * (Math.PI / 180);
                const tickId = (sec * currentBPS) + currentStep;
                if (tickId !== lastTickId) {
                    playTick(currentStep % 2 === 0);
                    lastTickId = tickId;
                }
            }

            secondHand.rotation.z = sAngle;
            minuteHand.rotation.z = -((min * 6) + (sec * 0.1)) * (Math.PI / 180);
            hourHand.rotation.z = -(((hour % 12) * 30) + (min * 0.5)) * (Math.PI / 180);

            targetRotationX = (mouseX * 0.001);
            targetRotationY = (mouseY * 0.001);
            watchGroup.rotation.y += (targetRotationX - watchGroup.rotation.y) * 0.05;
            watchGroup.rotation.x += (targetRotationY - watchGroup.rotation.x) * 0.05;

            updateWaveform();
            renderer.render(scene, camera);
            requestAnimationFrame(updateClock);
        }

        // --- UI LOGIC ---
        function toggleSelection() {
            selectionCollapsed = !selectionCollapsed;
            const bubble = document.getElementById('settings-bubble');
            const content = document.getElementById('bubble-content');
            const header = document.getElementById('expanded-header');
            const hint = document.getElementById('collapsed-hint');
            const icon = document.querySelector('.toggle-icon');
            const dragHint = document.getElementById('drag-hint-container');

            if (selectionCollapsed) {
                bubble.classList.remove('bubble-expanded');
                bubble.classList.add('bubble-collapsed');
                content.classList.add('hidden-content');
                header.classList.add('hidden-content');
                hint.classList.remove('hidden-content');
                icon.classList.add('rotated');
                dragHint.classList.add('opacity-0');
            } else {
                bubble.classList.add('bubble-expanded');
                bubble.classList.remove('bubble-collapsed');
                content.classList.remove('hidden-content');
                header.classList.remove('hidden-content');
                hint.classList.add('hidden-content');
                icon.classList.remove('rotated');
                dragHint.classList.remove('opacity-0');
            }
        }

        function setLang(lang) {
            currentLang = lang;
            document.getElementById('lang-en').classList.toggle('lang-active', lang === 'en');
            document.getElementById('lang-jp').classList.toggle('lang-active', lang === 'jp');
            document.getElementById('main-title').innerText = i18n[lang].title;
            document.getElementById('main-subtitle').innerText = i18n[lang].subtitle;
            document.getElementById('select-title').innerText = i18n[lang].select;
            document.getElementById('custom-label').innerText = i18n[lang].custom;
            document.getElementById('sound-label').innerText = i18n[lang].audio;
            document.getElementById('drag-hint').innerText = i18n[lang].hint;
            document.getElementById('wave-label').innerText = i18n[lang].wave;

            document.querySelectorAll('.bps-btn').forEach((btn, idx) => {
                const keys = [1, 4, 6, 8, 10, 16, 0];
                const key = keys[idx];
                btn.innerText = key === 0 ? i18n[lang].labels[0] : `${key} ${i18n[lang].bps_text}`;
            });
            updateUI();
        }

        function updateUI() {
            const data = i18n[currentLang];
            document.getElementById('bps-display').innerText = isContinuous ? data.cont_text : `${currentBPS} ${data.bps_text}`;
            document.getElementById('custom-val').innerText = isContinuous ? "∞" : currentBPS;
            const info = document.getElementById('info-text');
            if (isContinuous) info.innerText = data.infoMap[0];
            else if (data.infoMap[currentBPS]) info.innerText = data.infoMap[currentBPS];
            else info.innerText = data.infoMap.custom.replace('{x}', currentBPS);
        }

        function setBPS(bps) {
            currentBPS = bps;
            isContinuous = (bps === 0);
            document.querySelectorAll('.bps-btn').forEach(btn => btn.classList.remove('active-btn'));
            const clickedBtn = [...document.querySelectorAll('.bps-btn')].find(btn => 
                btn.innerText.includes(bps === 0 ? "Sweep" : bps + " BPS") ||
                btn.innerText.includes(bps === 0 ? "スイープ" : bps + " BPS")
            );
            if (clickedBtn) clickedBtn.classList.add('active-btn');
            document.getElementById('bps-slider').value = bps === 0 ? 60 : bps;
            updateUI();
        }

        document.getElementById('bps-slider').addEventListener('input', (e) => {
            currentBPS = parseInt(e.target.value);
            isContinuous = false;
            document.querySelectorAll('.bps-btn').forEach(btn => btn.classList.remove('active-btn'));
            updateUI();
        });

        window.onload = () => {
            initThree();
            setLang('en');
            updateClock();
        };
    </script>
</body>
</html>